<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORIX SCRIPTS | Cloudless Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #08080c; color: #e2e8f0; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(20, 20, 30, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); }
        .neon-border { border: 1px solid #8b5cf6; box-shadow: 0 0 15px rgba(139, 92, 246, 0.2); }
        .btn-main { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4); }
        .preview-area { width: 100%; height: 180px; border: 2px dashed #2d2d3f; border-radius: 20px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .script-card { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body class="pb-20">

    <!-- Навигация -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 mb-10">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg">M</div>
                <span class="text-2xl font-black tracking-tighter uppercase">Morix <span class="text-purple-500">Scripts</span></span>
            </div>
            <input type="text" id="searchInput" placeholder="Поиск по названию или коду..." 
                class="bg-black/40 border border-white/10 px-6 py-2 rounded-full w-full md:w-96 focus:border-purple-500 outline-none transition-all">
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Форма загрузки -->
        <div class="lg:col-span-4">
            <div class="glass p-8 rounded-[2rem] sticky top-28 border-purple-500/20">
                <h2 class="text-xl font-extrabold mb-6 flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-purple-500 rounded-full"></span> Создать пост
                </h2>
                
                <div class="space-y-4">
                    <input type="text" id="title" placeholder="Название скрипта" class="w-full bg-black/30 border border-white/5 p-3 rounded-xl focus:border-purple-500 outline-none">
                    <textarea id="code" placeholder="Вставь Lua код здесь..." class="w-full h-32 bg-black/30 border border-white/5 p-3 rounded-xl text-xs font-mono outline-none focus:border-purple-500"></textarea>
                    
                    <div class="space-y-2">
                        <label class="text-[10px] text-gray-500 uppercase font-bold ml-1">Медиа (Картинка или Видео 5с)</label>
                        <input type="file" id="fileInput" accept="image/*,video/*" class="hidden">
                        <div onclick="document.getElementById('fileInput').click()" id="preview" class="preview-area cursor-pointer hover:border-purple-500 transition-colors">
                            <span class="text-gray-500 text-sm text-center px-4">Нажми, чтобы прикрепить файл</span>
                        </div>
                    </div>

                    <button id="submitBtn" onclick="submitPost()" class="w-full btn-main text-white font-bold py-4 rounded-2xl">Опубликовать</button>
                </div>
            </div>
        </div>

        <!-- Список скриптов -->
        <div class="lg:col-span-8 space-y-6" id="list">
            <!-- Загрузка... -->
        </div>
    </main>

    <script>
        const API_URL = "https://morix.onrender.com"; // ЗАМЕНИ МЕНЯ
        let mediaBase64 = null;
        let mediaType = null;

        // Обработка выбора файла
        document.getElementById('fileInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Если видео - проверка длительности
            if (file.type.startsWith('video')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    if (video.duration > 5.9) {
                        alert("Видео слишком длинное (макс. 5 секунд)");
                        return;
                    }
                    convertToBase64(file);
                };
                video.src = URL.createObjectURL(file);
            } else {
                convertToBase64(file);
            }
        };

        function convertToBase64(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                mediaBase64 = e.target.result;
                mediaType = file.type.startsWith('image') ? 'image' : 'video';
                
                const preview = document.getElementById('preview');
                if (mediaType === 'image') {
                    preview.innerHTML = `<img src="${mediaBase64}" class="w-full h-full object-cover">`;
                } else {
                    preview.innerHTML = `<video src="${mediaBase64}" muted autoplay loop class="w-full h-full object-cover"></video>`;
                }
            };
            reader.readAsDataURL(file);
        }

        async function submitPost() {
            const title = document.getElementById('title').value;
            const code = document.getElementById('code').value;
            const btn = document.getElementById('submitBtn');

            if (!title || !code) return alert("Заполни название и код!");

            btn.disabled = true;
            btn.innerText = "Публикация...";

            try {
                const res = await fetch(`${API_URL}/scripts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title, code, mediaData: mediaBase64, mediaType
                    })
                });
                if (res.ok) location.reload();
            } catch (err) {
                alert("Ошибка при отправке");
                btn.disabled = false;
                btn.innerText = "Опубликовать";
            }
        }

        async function loadPosts(search = '') {
            const list = document.getElementById('list');
            try {
                const res = await fetch(`${API_URL}/scripts?search=${search}`);
                const data = await res.json();
                list.innerHTML = data.length ? '' : '<p class="text-center py-20 opacity-50">Ничего не найдено</p>';
                
                data.forEach(s => {
                    let mediaSection = '';
                    if (s.mediaData) {
                        mediaSection = s.mediaType === 'image' 
                            ? `<img src="${s.mediaData}" class="w-full h-64 object-cover rounded-2xl mb-4 shadow-lg">`
                            : `<video src="${s.mediaData}" autoplay muted loop class="w-full h-64 object-cover rounded-2xl mb-4 shadow-lg"></video>`;
                    }

                    list.innerHTML += `
                        <div class="glass p-6 rounded-[2rem] script-card border-white/5">
                            ${mediaSection}
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xl font-bold text-white">${s.title}</h3>
                                <span class="text-[10px] text-gray-500">${s.date}</span>
                            </div>
                            <div class="relative group mb-4">
                                <pre class="bg-black/60 p-4 rounded-2xl text-[11px] text-purple-300 overflow-x-auto border border-white/5 font-mono max-h-48"><code>${s.code}</code></pre>
                                <button onclick="copyCode(this, \`${s.code.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" 
                                    class="absolute top-2 right-2 bg-purple-600 p-2 rounded-lg opacity-0 group-hover:opacity-100 transition">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                list.innerHTML = '<p class="text-center text-red-400">Ошибка подключения к серверу</p>';
            }
        }

        function copyCode(btn, text) {
            navigator.clipboard.writeText(text);
            const oldIcon = btn.innerHTML;
            btn.innerHTML = '✅';
            setTimeout(() => btn.innerHTML = oldIcon, 2000);
        }

        document.getElementById('searchInput').oninput = (e) => loadPosts(e.target.value);
        loadPosts();
    </script>
</body>
</html>
