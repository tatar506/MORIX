<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORIX SCRIPTS | Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background: #050508; color: #e2e8f0; font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(17, 18, 27, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .btn-purple { background: #8b5cf6; transition: 0.3s; }
        .btn-purple:hover { box-shadow: 0 0 15px rgba(139, 92, 246, 0.5); transform: translateY(-2px); }
        .preview-box { width: 100%; height: 150px; border: 2px dashed #334155; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    </style>
</head>
<body class="pb-10">

    <nav class="glass sticky top-0 z-50 p-4 mb-8">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-purple-500">MORIX SCRIPTS</h1>
            <input type="text" id="searchInput" placeholder="Поиск..." class="bg-black/40 border border-white/10 px-4 py-2 rounded-full text-sm outline-none focus:border-purple-500">
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Форма -->
        <div class="lg:col-span-4">
            <div class="glass p-6 rounded-3xl sticky top-24">
                <h2 class="text-lg font-bold mb-4">Опубликовать</h2>
                <div class="space-y-3">
                    <input type="text" id="title" placeholder="Название" class="w-full bg-black/20 border border-white/5 p-3 rounded-xl text-sm">
                    <textarea id="code" placeholder="Код скрипта" class="w-full h-32 bg-black/20 border border-white/5 p-3 rounded-xl text-xs"></textarea>
                    
                    <!-- Загрузка медиа -->
                    <div class="space-y-2">
                        <label class="text-xs text-gray-400">Картинка или Видео (макс 5 сек)</label>
                        <input type="file" id="mediaInput" accept="image/*,video/*" class="hidden">
                        <div onclick="document.getElementById('mediaInput').click()" class="preview-box cursor-pointer" id="mediaPreview">
                            <span class="text-gray-500 text-xs">Нажми, чтобы выбрать файл</span>
                        </div>
                    </div>

                    <button id="uploadBtn" onclick="handleUpload()" class="w-full btn-purple py-3 rounded-xl font-bold text-sm">Залить</button>
                </div>
            </div>
        </div>

        <!-- Лента -->
        <div class="lg:col-span-8 space-y-6" id="scriptsList"></div>
    </main>

    <script>
        const API_URL = "ТВОЯ_ССЫЛКА_ОТ_RENDER"; 
        
        // ДАННЫЕ CLOUDINARY (создай бесплатный аккаунт на cloudinary.com)
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/ТВОЙ_CLOUDINARY_NAME/upload";
        const CLOUDINARY_PRESET = "ТВОЙ_UPLOAD_PRESET"; 

        let selectedFile = null;

        // Предпросмотр и проверка видео
        document.getElementById('mediaInput').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.type.startsWith('video')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function() {
                    if (video.duration > 5.5) { // с запасом 0.5 сек
                        alert("Видео слишком длинное! Максимум 5 секунд.");
                        document.getElementById('mediaInput').value = '';
                        return;
                    }
                    showPreview(file);
                };
                video.src = URL.createObjectURL(file);
            } else {
                showPreview(file);
            }
        };

        function showPreview(file) {
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('mediaPreview');
                if (file.type.startsWith('image')) {
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                } else {
                    preview.innerHTML = `<video src="${e.target.result}" muted autoplay loop class="w-full h-full object-cover"></video>`;
                }
            };
            reader.readAsDataURL(file);
        }

        async function handleUpload() {
            const title = document.getElementById('title').value;
            const code = document.getElementById('code').value;
            const uploadBtn = document.getElementById('uploadBtn');

            if (!title || !code) return alert("Заполни поля!");
            
            uploadBtn.innerText = "Загрузка...";
            uploadBtn.disabled = true;

            let mediaUrl = null;
            let mediaType = null;

            if (selectedFile) {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('upload_preset', CLOUDINARY_PRESET);

                const cloudRes = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const cloudData = await cloudRes.json();
                mediaUrl = cloudData.secure_url;
                mediaType = selectedFile.type.startsWith('image') ? 'image' : 'video';
            }

            const res = await fetch(`${API_URL}/scripts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, code, mediaUrl, mediaType })
            });

            if (res.ok) {
                location.reload();
            }
        }

        async function loadScripts(search = '') {
            const res = await fetch(`${API_URL}/scripts?search=${search}`);
            const data = await res.json();
            const list = document.getElementById('scriptsList');
            list.innerHTML = '';

            data.forEach(s => {
                let mediaHtml = '';
                if (s.mediaUrl) {
                    mediaHtml = s.mediaType === 'image' 
                        ? `<img src="${s.mediaUrl}" class="w-full h-48 object-cover rounded-2xl mb-4">`
                        : `<video src="${s.mediaUrl}" autoplay muted loop class="w-full h-48 object-cover rounded-2xl mb-4"></video>`;
                }

                list.innerHTML += `
                    <div class="glass p-6 rounded-3xl">
                        ${mediaHtml}
                        <h3 class="text-xl font-bold mb-2">${s.title}</h3>
                        <pre class="bg-black/50 p-4 rounded-xl text-xs text-purple-300 overflow-x-auto mb-4"><code>${s.code}</code></pre>
                        <button onclick="navigator.clipboard.writeText(\`${s.code}\`); alert('Скопировано!')" class="bg-white/5 hover:bg-purple-600 px-4 py-2 rounded-lg text-xs transition">Копировать Lua</button>
                    </div>
                `;
            });
        }

        document.getElementById('searchInput').oninput = (e) => loadScripts(e.target.value);
        loadScripts();
    </script>
</body>
</html>
